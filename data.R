#격자별 데이터 분석

library(data.table)
library(dplyr)
library(jtools)
library(stargazer)
library(Epi)
library(ROCR)
library(caret)


setwd("C:\\Users\\user\\Desktop\\프로젝트")
options("scipen"=100)

DF <- fread('grid_datafinal.csv', header = T, sep = ',')
View(DF)
colnames(DF)
str(DF)

DF[is.na(DF)] <- 0   
DF <- DF[,-'id']
DF$acc_kid <- ifelse(DF$acc_kid > 0, 1, 0)

DF1 <- subset(DF, subset = (DF$acc_kid == 1))
DF2 <- subset(DF, subset = (DF$acc_kid == 0))
l = 12345
ratio = 0.7
set.seed(1)

mod <- glm( acc_kid ~ ., data = DF , family = 'binomial')
summary(mod)


DF1$Sampling <- runif(nrow(DF1))
DF1 <- DF1[order(DF1$Sampling, decreasing = T),]
k <- as.integer(nrow(DF1) * ratio)
DF1_train <- DF1[c(1:k),]
DF1_test <- DF1[c((k+1):nrow(DF1)),]
set.seed(l)

DF2$Sampling <- runif(nrow(DF2))
DF2 <- DF2[order(DF2$Sampling, decreasing = T),]
k <- as.integer(nrow(DF2) * ratio)
DF2_train <- DF2[c(1:k),]
DF2_test <- DF2[c((k+1):nrow(DF2)),]


DF_train <- rbind(DF1_train, DF2_train)
DF_test <- rbind(DF1_test, DF2_test)
nrow(DF_train); prop.table(table(DF_train$acc_kid))
nrow(DF_test); prop.table(table(DF_test$acc_kid))


ES <- read.csv('result_estimate.csv', header = T, sep = ',', encoding = 'utf-8')
str(ES)
DF_train_s <- DF_train %>% select(acc_kid, ES$癤퓆ame)
mod1 <- glm(acc_kid ~ ., DF_train_s , family = 'binomial')



lm.Preds <- predict(mod1, DF_test, type = 'response')
lm.Preds[is.na(lm.Preds)] <- mean(lm.Preds, na.rm=T)
summary(lm.Preds)
pred.lm <- prediction(lm.Preds, DF_test$acc_kid)
perf.lm <- performance(pred.lm, 'tpr', 'fpr')


#ROC_CURVE
plot(perf.lm, xlim = c(0,1), ylim = c(0,1))
auc <- performance(pred.lm, measure = 'auc')
auc@y.values[[1]]

fitted.results.cat <- ifelse(lm.Preds > mean(lm.Preds, na.rm=T), 1,0)
fitted.results.cat <- as.factor(fitted.results.cat)
DF_test$acc_kid <- factor(DF_test$acc_kid)
confusionMatrix(data = fitted.results.cat, reference = DF_test$acc_kid , positive = '1')



#취약지수 산정
library(dplyr)
setwd("C:\\Users\\user\\Desktop\\프로젝트")
DF <- read.csv('grid_datafinal.csv', header = T, sep = ',')
ES <- read.csv('result_estimate.csv', header = T, sep = ',', encoding="utf-8")
str(ES)

rownames(DF) <- DF$id
rownames(ES) <- ES$癤퓆ame

DF_1 <- DF %>% select(ES$癤퓆ame) 
str(DF_1)
ES_1 <- ES[,"Estimate"] 
str(DF_1)


#행렬곱
idx <- as.matrix(DF_1) %*% as.matrix(ES_1)
DF_2 <- as.data.frame(idx)
DF_2 <- DF_2 %>% mutate(id = rownames(DF_2)) %>% select(id, V1)
head(DF_2)
summary(DF_2$V1)
        
DF_3 <- DF_2 %>% 
  mutate(idx_modi = (V1 - min(V1))/(max(V1) - min(V1)))
colnames(DF_3)
# 격자별 취약지수 저장
write.csv(DF_3, 'TSC_index.csv', na = "", row.names = F)
DF_3
